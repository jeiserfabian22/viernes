<!DOCTYPE html>
<html lang="en">

<head>
  {% load static %}
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>VENTAS</title>
  <meta content="" name="description">
  <meta content="" name="keywords">
  
  <!-- highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  


  <!-- Favicons -->
  <link href="{% static 'img/favicon.png' %}" rel="icon">
  <link href="{% static 'img/apple-touch-icon.png' %}" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
  
  <!-- Vendor CSS Files -->
  <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/boxicons/css/boxicons.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/quill/quill.snow.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/quill/quill.bubble.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/remixicon/remixicon.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/simple-datatables/style.css' %}" rel="stylesheet">


  <!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <!-- Template Main CSS File -->
  <link href="{% static 'css/style.css' %}" rel="stylesheet">

</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
      <a href="{% url 'index' %}" class="logo d-flex align-items-center">
        <img src="{% static 'img/mestanza.png' %}" alt="">
        <span class="d-none d-lg-block">ALIMARK</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><!-- End Logo -->

    <!-- Info Empresa -->
    <div class="header-info d-none d-md-flex align-items-center ms-4">
      <div class="company-info">
        <div class="company-name">{{ empresa.razonsocial }}</div>
        <div class="company-details">{{ empresa.ruc }}</div>
      </div>
      <div class="branch-info ms-4">
        <span class="branch-text">
          {{ sucursal.nombre_sucursal|default:"Sin sucursal" }} / 
          {{ caja.nombre_caja|default:"Sin caja" }} / 
          {{ almacen.nombre_almacen|default:"Sin almacén" }}
        </span>
      </div>
    </div>

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">

        <!-- Botón Gestión de Caja -->
        <li class="nav-item me-3">
          <a class="nav-link nav-icon" href="#" data-bs-toggle="modal" data-bs-target="#modalGestionCaja" title="Gestión de Caja">
            <i class="bi bi-cash-stack"></i>
            {% if apertura_actual %}
              <span class="badge bg-success">Abierta</span>
            {% else %}
              <span class="badge bg-danger">Cerrada</span>
            {% endif %}
          </a>
        </li>


        <!-- Icono de Teléfono -->
        <li class="nav-item me-3">
          <a class="nav-link nav-icon" href="#" title="Contacto">
            <i class="bi bi-telephone"></i>
          </a>
        </li>

        <!-- Icono de Notificaciones -->
        <li class="nav-item me-3">
          <a class="nav-link nav-icon" href="#" title="Notificaciones">
            <i class="bi bi-bell"></i>
            <span class="badge-number">9</span>
          </a>
        </li>

        <!-- Perfil de Usuario -->
        <li class="nav-item dropdown pe-3">
          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="https://i.pinimg.com/736x/28/44/88/284488453f7490e41e7467f4d4aefed2.jpg" alt="Profile" class="rounded-circle">
            <span class="d-none d-md-block ps-2">{{ nombrecompleto|truncatewords:2 }}</span>
            <i class="bi bi-chevron-down d-none d-md-block dropdown-toggle ps-1"></i>
          </a><!-- End Profile Image Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li>
              <p style="margin-left: 15px;"><strong>{{ nombrecompleto }}</strong></p>
              <a class="dropdown-item d-flex align-items-center" href="{% url 'logout' %}">
                <i class="bi bi-box-arrow-right"></i>
                <span>Cerrar sesión</span>
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>
          </ul><!-- End Profile Dropdown Items -->
        </li><!-- End Profile Nav -->

      </ul>
    </nav><!-- End Icons Navigation -->

  </header><!-- End Header -->


  <!-- ======= Sidebar ======= -->
  <aside id="sidebar" class="sidebar">
      <ul class="sidebar-nav" id="sidebar-nav">
          {% for nombre_grupo, grupo in modulos_organizados.items %}
              {% if grupo.hijos %}
                  <!-- Módulo Padre con Submenú -->
                  <li class="nav-item">
                      <a class="nav-link collapsed" data-bs-toggle="collapse" 
                        data-bs-target="#{{ grupo.padre.nombremodulo|slugify }}-nav">
                          <i class="{{ grupo.padre.logo }}"></i>
                          <span>{{ grupo.padre.nombremodulo }}</span>
                          <i class="bi bi-chevron-down ms-auto"></i>
                      </a>
                      <ul id="{{ grupo.padre.nombremodulo|slugify }}-nav" 
                          class="nav-content collapse" 
                          data-bs-parent="#sidebar-nav">
                          {% for hijo in grupo.hijos %}
                          <li>
                              <a href="{{ hijo.url }}">
                                  <i class="bi bi-circle"></i>
                                  <span>{{ hijo.nombremodulo }}</span>
                              </a>
                          </li>
                          {% endfor %}
                      </ul>
                  </li>
              {% else %}
                  <!-- Módulo Simple (sin hijos) -->
                  <li class="nav-item">
                      <a class="nav-link" href="{{ grupo.padre.url }}">
                          <i class="{{ grupo.padre.logo }}"></i>
                          <span>{{ grupo.padre.nombremodulo }}</span>
                      </a>
                  </li>
              {% endif %}
          {% endfor %}
      </ul>
  </aside>
  <!-- End Sidebar-->


{% block main %}
    
{% endblock %}



  <!-- ======= Footer ======= -->
<footer id="footer" class="footer">
    <div class="copyright">
      &copy; Jeiser <strong><span>AdmiBot</span></strong>. All Rights Reserved
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="{% static 'vendor/apexcharts/apexcharts.min.js' %}"></script>
  <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'vendor/chart.js/chart.umd.js' %}"></script>
  <script src="{% static 'js/producto.js' %}"></script>
 
  <script src="{% static 'vendor/quill/quill.min.js' %}"></script>
  <script src="{% static 'vendor/simple-datatables/simple-datatables.js' %}"></script>
  <script src="{% static 'vendor/tinymce/tinymce.min.js' %}"></script>
  <script src="{% static 'vendor/php-email-form/validate.js' %}"></script>
  <script src="https://kit.fontawesome.com/be2c92fd5f.js" crossorigin="anonymous"></script>
  <!-- Template Main JS File -->
  <script src="{% static 'js/main.js' %}"></script>
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


<!-- Modal unificado en base.html -->
<div class="modal fade" id="modalGestionCaja" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-gear"></i> Configuración de Trabajo
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        
        <!-- Mostrar info de caja abierta si existe -->
        {% if apertura_actual %}
        <div class="alert alert-success">
          <h6 class="alert-heading">
            <i class="bi bi-check-circle"></i> Caja Abierta
          </h6>
          <hr>
          <div class="row">
            <div class="col-md-6">
              <p class="mb-1"><strong>Caja:</strong> {{ apertura_actual.id_caja.nombre_caja }}</p>
              <p class="mb-1"><strong>Saldo Inicial:</strong> S/ {{ apertura_actual.saldo_inicial }}</p>
            </div>
            <div class="col-md-6">
              <p class="mb-1"><strong>Apertura:</strong> {{ apertura_actual.fecha_apertura|date:"d/m/Y" }} - {{ apertura_actual.hora_apertura|time:"H:i" }}</p>
            </div>
          </div>
          
          <button type="button" class="btn btn-danger btn-sm mt-2" data-bs-toggle="collapse" data-bs-target="#collapseCerrarCaja">
            <i class="bi bi-x-circle"></i> Cerrar Caja
          </button>
          
          <div class="collapse mt-3" id="collapseCerrarCaja">
            <form id="formCerrarCaja">
              {% csrf_token %}
              <div class="mb-3">
                <label for="saldo_final" class="form-label">Saldo Final:</label>
                <input type="number" class="form-control" id="saldo_final" name="saldo_final" 
                       step="0.01" min="0" required placeholder="0.00">
              </div>
              <button type="submit" class="btn btn-danger">
                <i class="bi bi-x-circle"></i> Confirmar Cierre
              </button>
            </form>
          </div>
        </div>
        
        <hr>
        {% endif %}
        
        <!-- Formulario de configuración -->
        <form id="formCambiarContexto">
          {% csrf_token %}
          
          <div class="row">
            <!-- Sucursal -->
            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="bi bi-building"></i> Sucursal:
              </label>
              <select class="form-select" id="select_sucursal" name="id_sucursal" required>
                <option value="">-- Seleccionar --</option>
              </select>
            </div>
            
            <!-- Almacén -->
            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="bi bi-box-seam"></i> Almacén:
              </label>
              <select class="form-select" id="select_almacen" name="id_almacen">
                <option value="">-- Seleccionar --</option>
              </select>
            </div>
          </div>
          
          <!-- Caja (opcional) -->
          <div class="mb-3">
            <label class="form-label">
              <i class="bi bi-inbox"></i> Caja (opcional - solo para referencia):
            </label>
            <select class="form-select" id="select_caja" name="id_caja">
              <option value="">-- Sin caja --</option>
            </select>
            <small class="text-muted">La caja se aperturará cuando realices una venta</small>
          </div>
          
          <button type="submit" class="btn btn-success w-100">
            <i class="bi bi-check-circle"></i> Aplicar Configuración
          </button>
        </form>
        
        <div id="mensajesCaja" class="mt-3"></div>
        
        <!-- Botón para aperturar caja manualmente -->
        {% if not apertura_actual %}
        <hr>
        <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="collapse" data-bs-target="#collapseAperturarCaja">
          <i class="bi bi-box-arrow-in-right"></i> Aperturar Caja Ahora (Opcional)
        </button>
        
        <div class="collapse mt-3" id="collapseAperturarCaja">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Si prefieres, puedes aperturar una caja ahora. De lo contrario, se te pedirá al realizar tu primera venta.
          </div>
          
          <form id="formAbrirCaja">
            {% csrf_token %}
            
            <div class="mb-3">
              <label for="caja_apertura" class="form-label">Caja:</label>
              <select class="form-select" id="caja_apertura" name="id_caja" required>
                <option value="">-- Seleccionar Caja --</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="almacen_apertura" class="form-label">Almacén:</label>
              <select class="form-select" id="almacen_apertura" name="id_almacen" required>
                <option value="">-- Seleccionar Almacén --</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="monto" class="form-label">Monto Inicial:</label>
              <input type="number" class="form-control" id="monto" name="monto" 
                     step="0.01" min="0" required placeholder="0.00">
            </div>
            
            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-box-arrow-in-right"></i> Aperturar Caja
            </button>
          </form>
        </div>
        {% endif %}
        
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modalGestionCaja = document.getElementById('modalGestionCaja');
    const formCambiarContexto = document.getElementById('formCambiarContexto');
    const formCerrarCaja = document.getElementById('formCerrarCaja');
    const formAbrirCaja = document.getElementById('formAbrirCaja');
    
    const selectSucursal = document.getElementById('select_sucursal');
    const selectCaja = document.getElementById('select_caja');
    const selectAlmacen = document.getElementById('select_almacen');
    
    const cajaApertura = document.getElementById('caja_apertura');
    const almacenApertura = document.getElementById('almacen_apertura');
    
    const mensajesCaja = document.getElementById('mensajesCaja');
    
    // Cargar datos al abrir el modal
    if (modalGestionCaja) {
        modalGestionCaja.addEventListener('show.bs.modal', function() {
            cargarDatosIniciales();
        });
    }
    
    // Función para cargar sucursales, cajas y almacenes
    function cargarDatosIniciales() {
        fetch('/api/obtener-datos-apertura/')
            .then(response => response.json())
            .then(data => {
                // Llenar sucursales
                selectSucursal.innerHTML = '<option value="">-- Seleccionar --</option>';
                data.sucursales.forEach(sucursal => {
                    const option = document.createElement('option');
                    option.value = sucursal.id;
                    option.textContent = sucursal.nombre;
                    selectSucursal.appendChild(option);
                });
                
                // Si no es admin y solo tiene una sucursal, cargar sus datos
                if (!data.es_admin && data.sucursales.length === 1) {
                    selectSucursal.value = data.sucursales[0].id;
                    
                    // Cargar cajas y almacenes
                    if (data.cajas.length > 0) {
                        selectCaja.innerHTML = '<option value="">-- Sin caja --</option>';
                        data.cajas.forEach(caja => {
                            const option = document.createElement('option');
                            option.value = caja.id;
                            option.textContent = `${caja.nombre} - Caja #${caja.numero}`;
                            selectCaja.appendChild(option);
                        });
                        
                        // Duplicar para formulario de apertura
                        if (cajaApertura) {
                            cajaApertura.innerHTML = '<option value="">-- Seleccionar --</option>';
                            data.cajas.forEach(caja => {
                                const option = document.createElement('option');
                                option.value = caja.id;
                                option.textContent = `${caja.nombre} - Caja #${caja.numero}`;
                                cajaApertura.appendChild(option);
                            });
                        }
                    }
                    
                    if (data.almacenes.length > 0) {
                        selectAlmacen.innerHTML = '<option value="">-- Seleccionar --</option>';
                        data.almacenes.forEach(almacen => {
                            const option = document.createElement('option');
                            option.value = almacen.id;
                            option.textContent = almacen.nombre;
                            selectAlmacen.appendChild(option);
                        });
                        
                        // Duplicar para formulario de apertura
                        if (almacenApertura) {
                            almacenApertura.innerHTML = '<option value="">-- Seleccionar --</option>';
                            data.almacenes.forEach(almacen => {
                                const option = document.createElement('option');
                                option.value = almacen.id;
                                option.textContent = almacen.nombre;
                                almacenApertura.appendChild(option);
                            });
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error al cargar datos', 'danger');
            });
    }
    
    // Cuando cambia la sucursal
    if (selectSucursal) {
        selectSucursal.addEventListener('change', function() {
            const idSucursal = this.value;
            
            if (idSucursal) {
                fetch(`/api/obtener-cajas-almacenes/?id_sucursal=${idSucursal}`)
                    .then(response => response.json())
                    .then(data => {
                        // Llenar cajas
                        selectCaja.innerHTML = '<option value="">-- Sin caja --</option>';
                        data.cajas.forEach(caja => {
                            const option = document.createElement('option');
                            option.value = caja.id;
                            option.textContent = `${caja.nombre} - Caja #${caja.numero}`;
                            selectCaja.appendChild(option);
                        });
                        
                        // Duplicar para formulario de apertura
                        if (cajaApertura) {
                            cajaApertura.innerHTML = '<option value="">-- Seleccionar --</option>';
                            data.cajas.forEach(caja => {
                                const option = document.createElement('option');
                                option.value = caja.id;
                                option.textContent = `${caja.nombre} - Caja #${caja.numero}`;
                                cajaApertura.appendChild(option);
                            });
                        }
                        
                        // Llenar almacenes
                        selectAlmacen.innerHTML = '<option value="">-- Seleccionar --</option>';
                        data.almacenes.forEach(almacen => {
                            const option = document.createElement('option');
                            option.value = almacen.id;
                            option.textContent = almacen.nombre;
                            selectAlmacen.appendChild(option);
                        });
                        
                        // Duplicar para formulario de apertura
                        if (almacenApertura) {
                            almacenApertura.innerHTML = '<option value="">-- Seleccionar --</option>';
                            data.almacenes.forEach(almacen => {
                                const option = document.createElement('option');
                                option.value = almacen.id;
                                option.textContent = almacen.nombre;
                                almacenApertura.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mostrarMensaje('Error al cargar cajas y almacenes', 'danger');
                    });
            } else {
                selectCaja.innerHTML = '<option value="">-- Sin caja --</option>';
                selectAlmacen.innerHTML = '<option value="">-- Seleccionar --</option>';
                if (cajaApertura) cajaApertura.innerHTML = '<option value="">-- Seleccionar --</option>';
                if (almacenApertura) almacenApertura.innerHTML = '<option value="">-- Seleccionar --</option>';
            }
        });
    }
    
    // Cambiar contexto (sucursal/caja/almacén)
    if (formCambiarContexto) {
        formCambiarContexto.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const btnSubmit = this.querySelector('button[type="submit"]');
            
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Aplicando...';
            
            fetch('/api/cambiar-contexto/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMensaje(data.mensaje, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    mostrarMensaje(data.error || 'Error al cambiar contexto', 'danger');
                    btnSubmit.disabled = false;
                    btnSubmit.innerHTML = '<i class="bi bi-check-circle"></i> Aplicar Configuración';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error en la solicitud', 'danger');
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="bi bi-check-circle"></i> Aplicar Configuración';
            });
        });
    }
    
    // Abrir caja manualmente
    if (formAbrirCaja) {
        formAbrirCaja.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // Agregar id_sucursal del select principal
            const idSucursal = selectSucursal.value;
            if (idSucursal) {
                formData.append('id_sucursal', idSucursal);
            }
            
            const btnSubmit = this.querySelector('button[type="submit"]');
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Aperturando...';
            
            fetch('/api/abrir-caja/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMensaje(data.mensaje, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    mostrarMensaje(data.error || 'Error al aperturar caja', 'danger');
                    btnSubmit.disabled = false;
                    btnSubmit.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Aperturar Caja';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error en la solicitud', 'danger');
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> Aperturar Caja';
            });
        });
    }
    
    // Cerrar caja
    if (formCerrarCaja) {
        formCerrarCaja.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!confirm('¿Está seguro de cerrar la caja?')) {
                return;
            }
            
            const formData = new FormData(this);
            const btnSubmit = this.querySelector('button[type="submit"]');
            
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Cerrando...';
            
            fetch('/api/cerrar-caja/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMensaje(data.mensaje, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    mostrarMensaje(data.error || 'Error al cerrar caja', 'danger');
                    btnSubmit.disabled = false;
                    btnSubmit.innerHTML = '<i class="bi bi-x-circle"></i> Confirmar Cierre';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('Error en la solicitud', 'danger');
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = '<i class="bi bi-x-circle"></i> Confirmar Cierre';
            });
        });
    }
    
    // Función para mostrar mensajes
    function mostrarMensaje(mensaje, tipo) {
        mensajesCaja.innerHTML = `
            <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
});
</script>




</body>

</html>