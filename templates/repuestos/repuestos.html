{% extends 'plantilla/base.html' %}

{% block main %}
<main id="main" class="main">

  <div class="pagetitle">
    <h1>Repuestos</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item active">Repuestos</li>
      </ol>
    </nav>
  </div>

  <section class="section dashboard">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Lista de Repuestos</h5>

            <a class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregar">Agregar repuesto</a>

            <!-- Modal AGREGAR -->
            <div class="modal" id="modalAgregar">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="formAgregar" action="{% url 'agregarRepuesto' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                      <h4 class="modal-title">Nuevo Repuesto</h4>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <label>Nombre</label>
                      <input type="text" name="nombre" id="nombre" class="form-control" required>

                      <label>Unidad</label>
                      <select class="form-select" name="unidad" required>
                        <option value="" disabled selected>Seleccione una unidad</option>
                        {% for unidad in unidades %}
                          <option value="{{ unidad.idunidad }}">{{ unidad.abrunidad }}</option>
                        {% endfor %}
                      </select>

                      <label>Marca</label>
                      <select class="form-select" name="marca" required>
                        <option value="" disabled selected>Seleccione una marca</option>
                        {% for marca in marcas %}
                          <option value="{{ marca.idmarca }}">{{ marca.nombremarca }}</option>
                        {% endfor %}
                      </select>

                      <label>Color</label>
                      <select class="form-select" name="color" required>
                        <option value="" disabled selected>Seleccione un color</option>
                        {% for color in colores %}
                          <option value="{{ color.idcolor }}">{{ color.nombrecolor }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-primary">Guardar</button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <!-- /Modal AGREGAR -->

            <!-- Tabla -->
            <table class="table datatable mt-3">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Nombre</th>
                  <th>Unidad</th>
                  <th>Marca</th>
                  <th>Color</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for repuesto in repuestos %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ repuesto.nombre }}</td>
                  <td>{{ repuesto.idunidad.abrunidad }}</td>
                  <td>{{ repuesto.idmarca.nombremarca }}</td>
                  <td>{{ repuesto.idcolor.nombrecolor }}</td>
                  <td>
                    <a class="btn" data-bs-toggle="modal" data-bs-target="#modalEditar{{repuesto.id_repuesto}}">
                      <i class="fa-solid fa-pen-to-square" style="color:#005eff;font-size:1.5rem;"></i>
                    </a>
                    <a href="{% url 'eliminarRepuesto' id_repuesto=repuesto.id_repuesto %}"
                       class="eliminar" onclick="return confirmarEliminar('{{ repuesto.id_repuesto }}', this)">
                      <i class="fa-solid fa-trash" style="color:#f71b02;font-size:1.5rem;"></i>
                    </a>
                  </td>
                </tr>

                <!-- Modal EDITAR -->
                <div class="modal" id="modalEditar{{repuesto.id_repuesto}}">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <form class="formEditar" action="{% url 'editarRepuesto' %}" method="post">
                        {% csrf_token %}
                        <div class="modal-header">
                          <h4 class="modal-title">Editar Repuesto</h4>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                          <input type="hidden" name="id_repuesto" value="{{ repuesto.id_repuesto }}">

                          <label>Nombre</label>
                          <input type="text" name="nombre2" value="{{ repuesto.nombre }}" class="form-control">

                          <label>Unidad</label>
                          <select class="form-select" name="unidad2">
                            <option value="{{ repuesto.idunidad.idunidad }}" selected>{{ repuesto.idunidad.abrunidad }}</option>
                            {% for unidad in unidades %}
                              <option value="{{ unidad.idunidad }}">{{ unidad.abrunidad }}</option>
                            {% endfor %}
                          </select>

                          <label>Marca</label>
                          <select class="form-select" name="marca2">
                            <option value="{{ repuesto.idmarca.idmarca }}" selected>{{ repuesto.idmarca.nombremarca }}</option>
                            {% for marca in marcas %}
                              <option value="{{ marca.idmarca }}">{{ marca.nombremarca }}</option>
                            {% endfor %}
                          </select>

                          <label>Color</label>
                          <select class="form-select" name="color2">
                            <option value="{{ repuesto.idcolor.idcolor }}" selected>{{ repuesto.idcolor.nombrecolor }}</option>
                            {% for color in colores %}
                              <option value="{{ color.idcolor }}">{{ color.nombrecolor }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div class="modal-footer">
                          <button type="submit" class="btn btn-primary">Guardar</button>
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <!-- /Modal EDITAR -->
                {% endfor %}
              </tbody>
            </table>

          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- ================= SCRIPTS ================= -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
  // Confirmar eliminación con SweetAlert
  function confirmarEliminar(id, enlace) {
    let urlEliminar = $(enlace).attr("href");
    Swal.fire({
      title: '¿Seguro que quieres eliminar este repuesto?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          type: "GET",
          url: urlEliminar,
          data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
          success: function () {
            window.location.href = "{% url 'repuestos' %}";
          }
        });
      }
    });
    return false;
  }

  // Confirmación para AGREGAR
  document.addEventListener('DOMContentLoaded', function () {
    const formAgregar = document.getElementById('formAgregar');
    if (formAgregar) {
      formAgregar.addEventListener('submit', function (e) {
        e.preventDefault();
        Swal.fire({
          title: '¿Guardar repuesto?',
          text: 'Se registrará el repuesto con los datos ingresados.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Sí, guardar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            formAgregar.submit();
          }
        });
      });
    }

    // Confirmación para EDITAR (varios formularios)
    const formsEditar = document.querySelectorAll('form.formEditar');
    formsEditar.forEach((form) => {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        Swal.fire({
          title: '¿Actualizar repuesto?',
          text: 'Se guardarán los cambios.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Sí, actualizar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            form.submit();
          }
        });
      });
    });
  });
</script>
{% endblock %}
