{% extends 'plantilla/base.html' %}
{% load url_filters %}  <!--⭐ AGREGAR ESTA LÍNEA -->

{% block main %}
<main id="main" class="main">

  <div class="pagetitle">
    <h1>Unidades</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'cpanel' %}">Home</a></li>
        <li class="breadcrumb-item active">Unidades</li>
      </ol>
    </nav>
  </div>

  <section class="section dashboard">
    <div class="row">
      <div class="col-lg-12"> 
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <h5 class="card-title">Lista de Unidades</h5> 

            <div class="table-responsive">
              <table class="table table-hover align-middle datatable">
                <thead class="table-dark">
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Código</th>
                    <th scope="col">Unidad</th>
                    <th scope="col">Estado</th>
                    <th scope="col" class="text-center">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for unidad in unidades %}
                  <tr>
                    <td class="fw-semibold">{{ forloop.counter }}</td>
                    <td>{{ unidad.codigounidad }}</td>
                    <td>{{ unidad.abrunidad }}</td>
                    <td>
                      {% if unidad.estado == 1 %}
                        <span class="badge bg-success">Unidad activa</span>    
                      {% else %}
                        <span class="badge bg-danger">Unidad desactivada</span>    
                      {% endif %}
                    </td>
                    <td class="text-center">
                      {% if unidad.estado == 1 %}
                        <!-- ⭐ Botón desactivar CON ID ENCRIPTADO -->
                        <a href="#" 
                           class="btn btn-sm btn-danger"
                           data-eid="{{ unidad.idunidad|eid }}"
                           data-nombre="{{ unidad.abrunidad }}"
                           onclick="desactivar(event, this)">
                          Desactivar
                        </a>
                      {% else %}
                        <!-- ⭐ Botón activar CON ID ENCRIPTADO -->
                        <a href="#" 
                           class="btn btn-sm btn-primary"
                           data-eid="{{ unidad.idunidad|eid }}"
                           data-nombre="{{ unidad.abrunidad }}"
                           onclick="activar(event, this)">
                          Activar
                        </a>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- DataTables + Bootstrap 5 -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(document).ready(function () {
    $('.datatable').DataTable({
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
      },
      pageLength: 5,
      lengthMenu: [5, 10, 25, 50],
      responsive: true
    });
  });

  // ⭐ FUNCIÓN ACTIVAR ACTUALIZADA CON ID ENCRIPTADO
  function activar(event, enlace) {
    event.preventDefault(); // Prevenir navegación
    
    const eid = $(enlace).data('eid');  // ⭐ Obtener ID encriptado
    const nombre = $(enlace).data('nombre');
    
    console.log('✅ Activando unidad con ID encriptado:', eid);
    
    Swal.fire({
      title: '¿Desea activar esta unidad?',
      html: `<p class="text-muted">${nombre}</p>`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#198754',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Sí, activar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        // Mostrar loading
        Swal.fire({
          title: 'Activando...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        // ⭐ AJAX con ID encriptado
        $.ajax({
          type: "GET",
          url: `/cat/und/on/${eid}/`,  // ⭐ URL con eid
          data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
          success: function(response) {
            if (response.status === 'success') {
              let fila = $(enlace).closest('tr');
              fila.find('td:nth-child(4)').html('<span class="badge bg-success">Unidad activa</span>');
              fila.find('td:nth-child(5)').html(`
                <a href="#" 
                   class="btn btn-sm btn-danger"
                   data-eid="${eid}"
                   data-nombre="${nombre}"
                   onclick="desactivar(event, this)">
                  Desactivar
                </a>
              `);
              
              Swal.fire({
                icon: 'success',
                title: 'Activado',
                text: response.message || 'Unidad activada correctamente',
                timer: 2000,
                showConfirmButton: false
              });
            } else {
              Swal.fire('Error', response.message, 'error');
            }
          },
          error: function(xhr) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: xhr.responseJSON?.message || 'No se pudo procesar la solicitud.'
            });
          }
        });
      }
    });
    return false;
  }

  // ⭐ FUNCIÓN DESACTIVAR ACTUALIZADA CON ID ENCRIPTADO
  function desactivar(event, enlace) {
    event.preventDefault(); // Prevenir navegación
    
    const eid = $(enlace).data('eid');  // ⭐ Obtener ID encriptado
    const nombre = $(enlace).data('nombre');
    
    console.log('⚠️ Desactivando unidad con ID encriptado:', eid);
    
    Swal.fire({
      title: '¿Desea desactivar esta unidad?',
      html: `<p class="text-muted">${nombre}</p>`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Sí, desactivar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        // Mostrar loading
        Swal.fire({
          title: 'Desactivando...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
        
        // ⭐ AJAX con ID encriptado
        $.ajax({
          type: "GET",
          url: `/cat/und/off/${eid}/`,  // ⭐ URL con eid
          data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
          success: function(response) {
            if (response.status === 'success') {
              let fila = $(enlace).closest('tr');
              fila.find('td:nth-child(4)').html('<span class="badge bg-danger">Unidad desactivada</span>');
              fila.find('td:nth-child(5)').html(`
                <a href="#" 
                   class="btn btn-sm btn-primary"
                   data-eid="${eid}"
                   data-nombre="${nombre}"
                   onclick="activar(event, this)">
                  Activar
                </a>
              `);
              
              Swal.fire({
                icon: 'success',
                title: 'Desactivado',
                text: response.message || 'Unidad desactivada correctamente',
                timer: 2000,
                showConfirmButton: false
              });
            } else {
              Swal.fire('Error', response.message, 'error');
            }
          },
          error: function(xhr) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: xhr.responseJSON?.message || 'No se pudo procesar la solicitud.'
            });
          }
        });
      }
    });
    return false;
  }
</script>
{% endblock %}