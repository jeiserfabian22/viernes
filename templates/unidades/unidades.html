{% extends 'plantilla/base.html' %}

{% block main %}
<main id="main" class="main">

  <div class="pagetitle">
    <h1>Unidades</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item active">Unidades</li>
      </ol>
    </nav>
  </div><!-- End Page Title -->

  <section class="section dashboard">
    <div class="row">
      <div class="col-lg-12"> 
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <h5 class="card-title">Lista de Unidades</h5> 

            <!-- Tabla con DataTables -->
            <div class="table-responsive">
              <table class="table table-hover align-middle datatable">
                <thead class="table-dark">
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Código</th>
                    <th scope="col">Unidad</th>
                    <th scope="col">Estado</th>
                    <th scope="col" class="text-center">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for unidad in unidades %}
                  <tr>
                    <td class="fw-semibold">{{ forloop.counter }}</td>
                    <td>{{ unidad.codigounidad }}</td>
                    <td>{{ unidad.abrunidad }}</td>
                    <td>
                      {% if unidad.estado == 1 %}
                        <span class="badge bg-success">Unidad activa</span>    
                      {% else %}
                        <span class="badge bg-danger">Unidad desactivada</span>    
                      {% endif %}
                    </td>
                    <td class="text-center">
                      {% if unidad.estado == 1 %}
                        <!-- Botón desactivar -->
                        <a href="{% url 'unidadesDesactivo' id=unidad.idunidad %}" 
                          class="btn btn-sm btn-danger"
                          onclick="return desactivar('{{ unidad.idunidad }}', this)">
                          Desactivar
                        </a>
                      {% else %}
                        <!-- Botón activar -->
                        <a href="{% url 'unidadesActivo' id=unidad.idunidad %}" 
                          class="btn btn-sm btn-primary"
                          onclick="return activar('{{ unidad.idunidad }}', this)">
                          Activar
                        </a>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <!-- End Tabla -->

          </div>
        </div>
      </div>
    </div>
  </section>

</main><!-- End #main -->

<!-- DataTables + Bootstrap 5 -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(document).ready(function () {
    $('.datatable').DataTable({
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
      },
      pageLength: 5,
      lengthMenu: [5, 10, 25, 50],
      responsive: true
    });
  });

// Activar unidad
  function activar(id, enlace) {
    let url = $(enlace).attr("href");
    Swal.fire({
      title: '¿Desea activar esta unidad?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#198754',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Sí',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          type: "GET",
          url: url,
          data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
          success: function(response) {
            if(response.status === 'success') {
              let fila = $(enlace).closest('tr');
              fila.find('td:nth-child(4)').html('<span class="badge bg-success">Unidad activa</span>');
              fila.find('td:nth-child(5)').html(`
                <a href="{% url 'unidadesDesactivo' id=0 %}`.replace("0", id) + `" 
                   class="btn btn-sm btn-danger"
                   onclick="return desactivar('${id}', this)">
                  Desactivar
                </a>
              `);
            } else {
              Swal.fire('Error', response.message, 'error');
            }
          },
          error: function() {
            Swal.fire('Error', 'No se pudo procesar la solicitud.', 'error');
          }
        });
      }
    });
    return false;
  }

  // Desactivar unidad
  function desactivar(id, enlace) {
    let url = $(enlace).attr("href");
    Swal.fire({
      title: '¿Desea desactivar esta unidad?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Sí',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          type: "GET",
          url: url,
          data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
          success: function(response) {
            if(response.status === 'success') {
              let fila = $(enlace).closest('tr');
              fila.find('td:nth-child(4)').html('<span class="badge bg-danger">Unidad desactivada</span>');
              fila.find('td:nth-child(5)').html(`
                <a href="{% url 'unidadesActivo' id=0 %}`.replace("0", id) + `" 
                   class="btn btn-sm btn-primary"
                   onclick="return activar('${id}', this)">
                  Activar
                </a>
              `);
            } else {
              Swal.fire('Error', response.message, 'error');
            }
          },
          error: function() {
            Swal.fire('Error', 'No se pudo procesar la solicitud.', 'error');
          }
        });
      }
    });
    return false;
  }
</script>
{% endblock %}
