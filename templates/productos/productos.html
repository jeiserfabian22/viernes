{% extends 'plantilla/base.html' %}

{% block main %}
<main id="main" class="main">

  <div class="pagetitle">
    <h1>Vehículos</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item active">Vehículos</li>
      </ol>
    </nav>
  </div>

  <section class="section dashboard">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Vehículos</h5>

            <a type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregar">
              Agregar vehículos
            </a>

            <!-- Modal AGREGAR -->
            <div class="modal" id="modalAgregar">
              <div class="modal-dialog">
                <div class="modal-content">

                  <div class="modal-header">
                    <h4 class="modal-title">Nuevo vehículo</h4>
                    <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
                  </div>

                  <div class="modal-body">
                    <form id="formAgregar" action="{% url 'productosAgregar' %}" method="post">
                      {% csrf_token %}

                      <label for="categoria">Tipo de vehículo</label>
                      <select class="form-select" name="categoria" required>
                        <option value="" disabled selected>Seleccione un tipo de vehículo</option>
                        {% for categoria in categorias %}
                          <option value="{{ categoria.idcategoria }}">{{ categoria.nomcategoria }}</option>
                        {% endfor %}
                      </select>

                      <label for="cilindrada">Cilindrada</label>
                      <select class="form-select" name="cilindrada" required>
                        <option value="" disabled selected>Seleccione la cilindrada</option>
                        {% for cilindrada in cilindrada %}
                          <option value="{{ cilindrada.idcilindrada }}">{{ cilindrada.cilindrada_cc }}</option>
                        {% endfor %}
                      </select>

                      <label for="marca">Marca</label>
                      <select class="form-select" name="marca" required>
                        <option value="" disabled selected>Seleccione una marca</option>
                        {% for marca in marcas %}
                          <option value="{{ marca.idmarca }}">{{ marca.nombremarca }}</option>
                        {% endfor %}
                      </select>

                      <label for="color">Color</label>
                      <select class="form-select" name="color" required>
                        <option value="" disabled selected>Seleccione un color</option>
                        {% for color in color %}
                          <option value="{{ color.idcolor }}">{{ color.nombrecolor }}</option>
                        {% endfor %}
                      </select>

                      <label for="unidad">Unidad</label>
                      <select class="form-select" name="unidad" required>
                        <option value="" disabled selected>Seleccione una unidad</option>
                        {% for unidad in unidades %}
                          <option value="{{ unidad.idunidad }}">{{ unidad.abrunidad }}</option>
                        {% endfor %}
                      </select>

                      <label for="nombreProducto">Nombre</label>
                      <input type="text" name="nombreProducto" id="nombreProducto" class="form-control" readonly>

                      <!-- imagenprod es un varchar en BD; si no usarás imagen, puedes dejarlo vacío 
                      <label for="imagenprod" class="mt-2">Imagen (URL o ruta)</label>
                      <input type="text" name="imagenprod" id="imagenprod" class="form-control">-->

                      <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Agregar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                      </div>
                    </form>
                  </div>

                </div>
              </div>
            </div>
            <!-- /Modal AGREGAR -->

            <!-- Tabla -->
            <table class="table datatable mt-3">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Producto</th>
                  <th>Tipo de vehículo</th>
                  <th>Unidad</th>
                  <th>Marca</th>
                  <th>Cilindrada</th>
                  <th>Color</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for producto in productos %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ producto.nomproducto }}</td>
                  <td>{{ producto.idcategoria.nomcategoria }}</td>
                  <td>{{ producto.idunidad.abrunidad }}</td>
                  <td>{{ producto.idmarca.nombremarca }}</td>
                  <td>{{ producto.idcilindrada.cilindrada_cc }}</td>
                  <td>{{ producto.idcolor.nombrecolor }}</td>
                  <td class="d-flex gap-2">
                    <a class="btn" data-bs-toggle="modal" data-bs-target="#modalEditar{{producto.idproducto}}">
                      <i class="fa-solid fa-pen-to-square" style="color:#005eff;font-size:1.5rem;"></i>
                    </a>
                    <a href="{% url 'eliminarProducto' idproducto=producto.idproducto %}"
                       class="eliminar" onclick="return confirmarEliminar('{{ producto.idproducto }}', this)">
                      <i class="fa-solid fa-trash" style="color:#f71b02;font-size:1.5rem;"></i>
                    </a>
                  </td>
                </tr>

                <!-- Modal EDITAR -->
                <div class="modal" id="modalEditar{{producto.idproducto}}">
                  <div class="modal-dialog">
                    <div class="modal-content">

                      <div class="modal-header">
                        <h4 class="modal-title">Editar producto</h4>
                        <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
                      </div>

                      <div class="modal-body">
                        <form class="formEditar" action="{% url 'productosEditado' %}" method="post">
                          {% csrf_token %}

                          <input type="hidden" name="idproducto2" value="{{ producto.idproducto }}">

                          <label>Tipo de vehículo</label>
                          <select class="form-select" name="categoria2">
                            <option value="{{ producto.idcategoria.idcategoria }}" selected>
                              {{ producto.idcategoria.nomcategoria }}
                            </option>
                            {% for categoria in categorias %}
                              <option value="{{ categoria.idcategoria }}">{{ categoria.nomcategoria }}</option>
                            {% endfor %}
                          </select>

                          <label>Unidad</label>
                          <select class="form-select" name="unidad2">
                            <option value="{{ producto.idunidad.idunidad }}" selected>
                              {{ producto.idunidad.abrunidad }}
                            </option>
                            {% for unidad in unidades %}
                              <option value="{{ unidad.idunidad }}">{{ unidad.abrunidad }}</option>
                            {% endfor %}
                          </select>

                          <label>Marca</label>
                          <select class="form-select" name="marca2">
                            <option value="{{ producto.idmarca.idmarca }}" selected>
                              {{ producto.idmarca.nombremarca }}
                            </option>
                            {% for marca in marcas %}
                              <option value="{{ marca.idmarca }}">{{ marca.nombremarca }}</option>
                            {% endfor %}
                          </select>

                          <label>Cilindrada</label>
                          <select class="form-select" name="cilindrada2">
                            <option value="{{ producto.idcilindrada.idcilindrada }}" selected>
                              {{ producto.idcilindrada.cilindrada_cc }}
                            </option>
                            {% for cil in cilindrada %}
                              <option value="{{ cil.idcilindrada }}">{{ cil.cilindrada_cc }}</option>
                            {% endfor %}
                          </select>

                          <label>Color</label>
                          <select class="form-select" name="color2">
                            <option value="{{ producto.idcolor.idcolor }}" selected>
                              {{ producto.idcolor.nombrecolor }}
                            </option>
                            {% for c in color %}
                              <option value="{{ c.idcolor }}">{{ c.nombrecolor }}</option>
                            {% endfor %}
                          </select>

                          <label>Nombre</label>
                          <input type="text" name="nombreProducto2" id="nombreProducto2_{{producto.idproducto}}"
                                 value="{{ producto.nomproducto }}" class="form-control">

                          <label class="mt-2">Imagen (URL o ruta)</label>
                          <input type="text" name="imagenprod2" id="imagenprod2_{{producto.idproducto}}"
                                 value="{{ producto.imagenprod }}" class="form-control">

                          <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Editar</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                          </div>
                        </form>
                      </div>

                    </div>
                  </div>
                </div>
                <!-- /Modal EDITAR -->
                {% endfor %}
              </tbody>
            </table>

          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
  // Confirmar eliminación
  function confirmarEliminar(idproducto, enlace) {
    let urlEliminar = $(enlace).attr("href");
    Swal.fire({
      title: '¿Seguro que quieres eliminar este producto?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          type: "GET",
          url: urlEliminar,
          data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
          success: function () {
            window.location.href = "{% url 'productos' %}";
          }
        });
      }
    });
    return false;
  }

  // Construir nombre automáticamente (modal AGREGAR)
  function actualizarNombreNuevo() {
    const tipoVehiculo = document.querySelector('#modalAgregar select[name="categoria"] option:checked')?.text || '';
    const cil = document.querySelector('#modalAgregar select[name="cilindrada"] option:checked')?.text || '';
    const marca = document.querySelector('#modalAgregar select[name="marca"] option:checked')?.text || '';
    const color = document.querySelector('#modalAgregar select[name="color"] option:checked')?.text || '';
    document.getElementById('nombreProducto').value = `${tipoVehiculo} ${cil} ${marca} ${color}`.trim();
  }
  document.addEventListener('change', function(e){
    if (e.target.closest('#modalAgregar')) actualizarNombreNuevo();
  });
  document.addEventListener('DOMContentLoaded', actualizarNombreNuevo);


  // Confirmación para AGREGAR
  document.addEventListener('DOMContentLoaded', function () {
    const formAgregar = document.getElementById('formAgregar');
    if (formAgregar) {
      formAgregar.addEventListener('submit', function (e) {
        e.preventDefault();
        Swal.fire({
          title: '¿Guardar producto?',
          text: 'Se registrará el producto con los datos ingresados.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Sí, guardar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            formAgregar.submit(); // POST normal a tu view
          }
        });
      });
    }

    // Confirmación para EDITAR (varios formularios)
    const formsEditar = document.querySelectorAll('form.formEditar');
    formsEditar.forEach((form) => {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        Swal.fire({
          title: '¿Actualizar producto?',
          text: 'Se guardarán los cambios del producto.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Sí, actualizar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            form.submit(); // POST normal a tu view
          }
        });
      });
    });
  });
  
</script>
{% endblock %}
