{% extends 'plantilla/base.html' %}
{% block main %}
<main id="main" class="main">
  <!-- Encabezado -->
  <div class="pagetitle d-flex justify-content-between align-items-center">
    <h1 class="fw-bold text-primary">
      <i class="fa-solid fa-id-card me-2"></i>Imposici√≥n de Placas
    </h1>
    <button type="button" class="btn btn-success rounded-pill shadow-sm" data-bs-toggle="modal" data-bs-target="#modalNuevaImposicion">
      <i class="fa-solid fa-circle-plus me-2"></i>Nueva Imposici√≥n
    </button>
  </div>

  <nav aria-label="breadcrumb" class="mt-2">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'cpanel' %}">Home</a></li>
      <li class="breadcrumb-item active">Imposici√≥n de Placas</li>
    </ol>
  </nav>

  <!-- Tarjetas de Estad√≠sticas -->
  <section class="section mt-3">
    <div class="row">
      <div class="col-lg-3 col-md-6">
        <div class="card info-card sales-card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Total <span>| Registros</span></h5>
            <div class="d-flex align-items-center">
              <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background: #e0f2fe;">
                <i class="fa-solid fa-clipboard-list text-primary"></i>
              </div>
              <div class="ps-3">
                <h6 class="fw-bold">{{ estadisticas.total }}</h6>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6">
        <div class="card info-card revenue-card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Pendientes <span>| Por iniciar</span></h5>
            <div class="d-flex align-items-center">
              <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background: #fef3c7;">
                <i class="fa-solid fa-clock text-warning"></i>
              </div>
              <div class="ps-3">
                <h6 class="fw-bold text-warning">{{ estadisticas.pendientes }}</h6>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6">
        <div class="card info-card customers-card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="card-title">En Tr√°mite <span>| Procesando</span></h5>
            <div class="d-flex align-items-center">
              <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background: #dbeafe;">
                <i class="fa-solid fa-spinner text-info"></i>
              </div>
              <div class="ps-3">
                <h6 class="fw-bold text-info">{{ estadisticas.en_tramite }}</h6>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6">
        <div class="card info-card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Completados <span>| Finalizados</span></h5>
            <div class="d-flex align-items-center">
              <div class="card-icon rounded-circle d-flex align-items-center justify-content-center" style="background: #d1fae5;">
                <i class="fa-solid fa-check-circle text-success"></i>
              </div>
              <div class="ps-3">
                <h6 class="fw-bold text-success">{{ estadisticas.completados }}</h6>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Contenido Principal -->
  <section class="section dashboard mt-2">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="card-title">Listado de Imposiciones de Placas</h5>
        
        <div class="table-responsive">
          <table class="table table-hover align-middle datatable">
            <thead class="table-dark">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Cliente</th>
                <th scope="col">Veh√≠culo</th>
                <th scope="col">N¬∞ Placa</th>
                <th scope="col">Tipo</th>
                <th scope="col">Fecha Solicitud</th>
                <th scope="col" class="text-end">Total Costo</th>
                <th scope="col" class="text-center">Estado</th>
                <th scope="col" class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for imp in imposiciones %}
              <tr>
                <td class="fw-semibold">{{ forloop.counter }}</td>
                <td>
                  <span class="fw-semibold">{{ imp.idcliente.razonsocial }}</span>
                  <br>
                  <small class="text-muted">{{ imp.idcliente.numdoc }}</small>
                </td>
                <td>
                  <span class="fw-semibold">{{ imp.id_vehiculo.idproducto.nomproducto }}</span>
                  <br>
                  <small class="text-muted">Motor: {{ imp.id_vehiculo.serie_motor|truncatechars:15 }}</small>
                </td>
                <td>
                  {% if imp.numero_placa %}
                    <span class="badge bg-dark fs-6">{{ imp.numero_placa }}</span>
                  {% else %}
                    <span class="badge bg-secondary">Sin asignar</span>
                  {% endif %}
                </td>
                <td>
                  {% if imp.tipo_placa == 'nueva' %}
                    <span class="badge bg-success">Nueva</span>
                  {% elif imp.tipo_placa == 'transferencia' %}
                    <span class="badge bg-info">Transferencia</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">Duplicado</span>
                  {% endif %}
                </td>
                <td>{{ imp.fecha_solicitud|date:"d/m/Y" }}</td>
                <td class="text-end fw-bold">S/ {{ imp.total_costo|floatformat:2 }}</td>
                <td class="text-center">
                  {% if imp.estado_tramite == 'pendiente' %}
                    <span class="badge bg-warning text-dark">
                      <i class="fa-solid fa-clock me-1"></i>Pendiente
                    </span>
                  {% elif imp.estado_tramite == 'en_tramite' %}
                    <span class="badge bg-info">
                      <i class="fa-solid fa-spinner me-1"></i>En Tr√°mite
                    </span>
                  {% elif imp.estado_tramite == 'completado' %}
                    <span class="badge bg-success">
                      <i class="fa-solid fa-check me-1"></i>Completado
                    </span>
                  {% else %}
                    <span class="badge bg-danger">
                      <i class="fa-solid fa-ban me-1"></i>Cancelado
                    </span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-info" onclick="verDetalle({{ imp.id_imposicion }})" title="Ver Detalle">
                      <i class="fa-solid fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-primary" onclick="editarImposicion({{ imp.id_imposicion }})" title="Editar">
                      <i class="fa-solid fa-edit"></i>
                    </button>
                    {% if imp.estado_tramite != 'completado' and imp.estado_tramite != 'cancelado' %}
                    <button type="button" class="btn btn-success" onclick="cambiarEstado({{ imp.id_imposicion }}, '{{ imp.estado_tramite }}')" title="Cambiar Estado">
                      <i class="fa-solid fa-exchange-alt"></i>
                    </button>
                    {% endif %}
                    <a href="{% url 'imprimir_constancia_placa' imp.id_imposicion %}" class="btn btn-secondary" target="_blank" title="Imprimir">
                      <i class="fa-solid fa-print"></i>
                    </a>
                    {% if imp.estado_tramite == 'pendiente' %}
                    <button type="button" class="btn btn-danger" onclick="eliminarImposicion({{ imp.id_imposicion }})" title="Eliminar">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">
                  <i class="fa-solid fa-inbox fa-3x mb-3 d-block"></i>
                  No hay imposiciones de placas registradas
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal Nueva Imposici√≥n -->
  <div class="modal fade" id="modalNuevaImposicion" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">
            <i class="fa-solid fa-id-card me-2"></i>Nueva Imposici√≥n de Placa
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formNuevaImposicion" action="{% url 'nueva_imposicion' %}" method="post">
            {% csrf_token %}
            
            <!-- Selecci√≥n de Venta y Veh√≠culo -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold"><i class="fa-solid fa-motorcycle me-2"></i>Selecci√≥n de Veh√≠culo</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-semibold">Venta <span class="text-danger">*</span></label>
                    <select name="idventa" id="select_venta" class="form-select" required>
                      <option value="">Seleccione una venta</option>
                      {% for detalle in ventas_con_vehiculos %}
                      <option value="{{ detalle.idventa.idventa }}" 
                              data-cliente="{{ detalle.idventa.idcliente.razonsocial }}"
                              data-comprobante="{{ detalle.idventa.numero_comprobante }}">
                        {{ detalle.idventa.numero_comprobante }} - {{ detalle.idventa.idcliente.razonsocial|truncatechars:30 }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-semibold">Veh√≠culo <span class="text-danger">*</span></label>
                    <select name="id_vehiculo" id="select_vehiculo" class="form-select" required disabled>
                      <option value="">Primero seleccione una venta</option>
                    </select>
                  </div>
                </div>
                
                <!-- Info del veh√≠culo seleccionado -->
                <div id="info_vehiculo" class="alert alert-info mt-3 d-none">
                  <div class="row">
                    <div class="col-md-4"><strong>Producto:</strong> <span id="info_producto"></span></div>
                    <div class="col-md-4"><strong>Motor:</strong> <span id="info_motor"></span></div>
                    <div class="col-md-4"><strong>Chasis:</strong> <span id="info_chasis"></span></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Datos de la Placa -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold"><i class="fa-solid fa-rectangle-list me-2"></i>Datos de la Placa</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label fw-semibold">Tipo de Placa <span class="text-danger">*</span></label>
                    <select name="tipo_placa" class="form-select" required>
                      <option value="nueva">Placa Nueva</option>
                      <option value="transferencia">Transferencia</option>
                      <option value="duplicado">Duplicado</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-semibold">N¬∞ de Placa</label>
                    <input type="text" name="numero_placa" class="form-control text-uppercase" placeholder="ABC-123" maxlength="10">
                    <small class="text-muted">Dejar vac√≠o si a√∫n no tiene</small>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-semibold">N¬∞ Expediente</label>
                    <input type="text" name="numero_expediente" class="form-control" placeholder="EXP-001">
                  </div>
                </div>
              </div>
            </div>

            <!-- Fechas -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold"><i class="fa-solid fa-calendar me-2"></i>Fechas del Tr√°mite</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-semibold">Fecha de Tr√°mite</label>
                    <input type="date" name="fecha_tramite" class="form-control">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-semibold">Fecha Vencimiento Tr√°mite</label>
                    <input type="date" name="fecha_vencimiento_tramite" class="form-control">
                  </div>
                </div>
              </div>
            </div>

            <!-- Costos -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold"><i class="fa-solid fa-money-bill me-2"></i>Costos</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label fw-semibold">Costo Tr√°mite</label>
                    <div class="input-group">
                      <span class="input-group-text">S/</span>
                      <input type="number" name="costo_tramite" class="form-control costo-input" step="0.01" min="0" value="0.00">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label fw-semibold">Costo Placa</label>
                    <div class="input-group">
                      <span class="input-group-text">S/</span>
                      <input type="number" name="costo_placa" class="form-control costo-input" step="0.01" min="0" value="0.00">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label fw-semibold">Otros Costos</label>
                    <div class="input-group">
                      <span class="input-group-text">S/</span>
                      <input type="number" name="otros_costos" class="form-control costo-input" step="0.01" min="0" value="0.00">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label fw-semibold">Total</label>
                    <div class="input-group">
                      <span class="input-group-text">S/</span>
                      <input type="text" id="total_costo" class="form-control fw-bold" value="0.00" readonly>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Documentaci√≥n -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <h6 class="mb-0 fw-bold"><i class="fa-solid fa-file-alt me-2"></i>Documentaci√≥n</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" name="tiene_tarjeta_propiedad" id="tiene_tarjeta">
                      <label class="form-check-label" for="tiene_tarjeta">Tarjeta de Propiedad</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" name="tiene_soat" id="tiene_soat">
                      <label class="form-check-label" for="tiene_soat">SOAT</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" name="tiene_revision_tecnica" id="tiene_revision">
                      <label class="form-check-label" for="tiene_revision">Revisi√≥n T√©cnica</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Observaciones -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Observaciones</label>
              <textarea name="observaciones" class="form-control" rows="2" placeholder="Observaciones adicionales..."></textarea>
            </div>

            <div class="modal-footer px-0 pb-0">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success" id="btnGuardarImposicion">
                <i class="fa-solid fa-save me-2"></i>Guardar Imposici√≥n
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ver Detalle -->
  <div class="modal fade" id="modalVerDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title"><i class="fa-solid fa-eye me-2"></i>Detalle de Imposici√≥n</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="contenidoDetalle">
          <!-- Se llena din√°micamente -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editar Imposici√≥n -->
  <div class="modal fade" id="modalEditarImposicion" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fa-solid fa-edit me-2"></i>Editar Imposici√≥n</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="contenidoEditar">
          <!-- Se llena din√°micamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Cambiar Estado -->
  <div class="modal fade" id="modalCambiarEstado" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fa-solid fa-exchange-alt me-2"></i>Cambiar Estado</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formCambiarEstado">
            {% csrf_token %}
            <input type="hidden" id="id_imposicion_estado" name="id_imposicion">
            
            <div class="mb-3">
              <label class="form-label fw-semibold">Nuevo Estado</label>
              <select name="nuevo_estado" id="nuevo_estado" class="form-select" required>
                <option value="pendiente">Pendiente</option>
                <option value="en_tramite">En Tr√°mite</option>
                <option value="completado">Completado</option>
                <option value="cancelado">Cancelado</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-semibold">Comentario</label>
              <textarea name="comentario" class="form-control" rows="3" placeholder="Motivo del cambio..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" onclick="confirmarCambioEstado()">
            <i class="fa-solid fa-check me-2"></i>Confirmar
          </button>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
// ‚úÖ SOLUCI√ìN: Usar IIFE para evitar redeclaraci√≥n de variables
const vehiculosPorVenta = {};

{% for detalle in ventas_con_vehiculos %}
  {% if detalle.id_vehiculo %}
    (function() {
      var idventaTemp = {{ detalle.idventa.idventa }};
      
      if (!vehiculosPorVenta[idventaTemp]) {
        vehiculosPorVenta[idventaTemp] = [];
      }
      
      vehiculosPorVenta[idventaTemp].push({
        id: {{ detalle.id_vehiculo.id_vehiculo }},
        producto: "{{ detalle.id_vehiculo.idproducto.nomproducto|escapejs }}",
        motor: "{{ detalle.id_vehiculo.serie_motor|escapejs }}",
        chasis: "{{ detalle.id_vehiculo.serie_chasis|escapejs }}"
      });
    })();
  {% endif %}
{% endfor %}

console.log("Veh√≠culos cargados por venta:", vehiculosPorVenta);

$(document).ready(function() {
  
  // ========================================
  // EVENTO: CAMBIO DE VENTA
  // ========================================
  $('#select_venta').on('change', function() {
    var idventa = parseInt($(this).val());
    var $selectVehiculo = $('#select_vehiculo');
    
    console.log("üìã Venta seleccionada:", idventa);
    
    $selectVehiculo.empty().append('<option value="">Seleccione un veh√≠culo</option>');
    $('#info_vehiculo').addClass('d-none');
    
    if (idventa && vehiculosPorVenta[idventa]) {
      var vehiculos = vehiculosPorVenta[idventa];
      console.log("üöô Veh√≠culos encontrados:", vehiculos.length);
      
      if (vehiculos.length > 0) {
        vehiculos.forEach(function(v) {
          $selectVehiculo.append(
            $('<option></option>')
              .attr('value', v.id)
              .attr('data-producto', v.producto)
              .attr('data-motor', v.motor)
              .attr('data-chasis', v.chasis)
              .text(v.producto + ' - Motor: ' + v.motor.substring(0, 15))
          );
        });
        
        $selectVehiculo.prop('disabled', false);
        console.log("‚úÖ Veh√≠culos cargados correctamente");
      } else {
        $selectVehiculo.append('<option value="">Sin veh√≠culos disponibles</option>');
        $selectVehiculo.prop('disabled', true);
        console.warn("‚ö†Ô∏è Array vac√≠o para esta venta");
      }
    } else {
      $selectVehiculo.prop('disabled', true);
      console.warn("‚ö†Ô∏è No hay veh√≠culos para idventa:", idventa);
    }
  });

  // ========================================
  // EVENTO: CAMBIO DE VEH√çCULO
  // ========================================
  $('#select_vehiculo').on('change', function() {
    var $selected = $(this).find(':selected');
    var valor = $selected.val();
    
    if (valor) {
      var producto = $selected.data('producto');
      var motor = $selected.data('motor');
      var chasis = $selected.data('chasis');
      
      $('#info_producto').text(producto);
      $('#info_motor').text(motor);
      $('#info_chasis').text(chasis);
      $('#info_vehiculo').removeClass('d-none');
      
      console.log("‚úÖ Veh√≠culo seleccionado:", { producto: producto, motor: motor, chasis: chasis });
    } else {
      $('#info_vehiculo').addClass('d-none');
    }
  });

  // ========================================
  // C√ÅLCULO AUTOM√ÅTICO DE TOTAL COSTOS
  // ========================================
  $('.costo-input').on('input', function() {
    var total = 0;
    $('.costo-input').each(function() {
      var valor = parseFloat($(this).val()) || 0;
      total += valor;
    });
    $('#total_costo').val(total.toFixed(2));
  });

  // ========================================
  // SUBMIT: NUEVA IMPOSICI√ìN
  // ========================================
  $('#formNuevaImposicion').on('submit', function(e) {
    e.preventDefault();
    
    var vehiculoSeleccionado = $('#select_vehiculo').val();
    if (!vehiculoSeleccionado) {
      Swal.fire({
        icon: 'warning',
        title: 'Faltan datos',
        text: 'Debe seleccionar un veh√≠culo',
        confirmButtonColor: '#f0ad4e'
      });
      return;
    }
    
    var ventaSeleccionada = $('#select_venta').val();
    if (!ventaSeleccionada) {
      Swal.fire({
        icon: 'warning',
        title: 'Faltan datos',
        text: 'Debe seleccionar una venta',
        confirmButtonColor: '#f0ad4e'
      });
      return;
    }
    
    Swal.fire({
      title: 'Procesando...',
      text: 'Registrando imposici√≥n de placa',
      allowOutsideClick: false,
      showConfirmButton: false,
      willOpen: function() { Swal.showLoading(); }
    });

    $.ajax({
      type: 'POST',
      url: $(this).attr('action'),
      data: new FormData(this),
      processData: false,
      contentType: false,
      success: function(res) {
        if (res.ok) {
          Swal.fire({
            icon: 'success',
            title: '¬°Registrado!',
            text: res.message,
            confirmButtonColor: '#198754'
          }).then(function() {
            location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: res.error,
            confirmButtonColor: '#dc3545'
          });
        }
      },
      error: function(xhr) {
        var res = xhr.responseJSON || {};
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: res.error || 'Error al procesar la solicitud',
          confirmButtonColor: '#dc3545'
        });
      }
    });
  });
});

// ========================================
// FUNCI√ìN: VER DETALLE
// ========================================
function verDetalle(id) {
  Swal.fire({
    title: 'Cargando...',
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: function() { Swal.showLoading(); }
  });
  
  $.get('/imposicion-placas/detalle/' + id + '/', function(res) {
    Swal.close();
    
    if (res.ok) {
      var d = res.data;
      
      var estadoBadge = '';
      if (d.estado_tramite === 'completado') {
        estadoBadge = '<span class="badge bg-success">COMPLETADO</span>';
      } else if (d.estado_tramite === 'en_tramite') {
        estadoBadge = '<span class="badge bg-info">EN TR√ÅMITE</span>';
      } else if (d.estado_tramite === 'cancelado') {
        estadoBadge = '<span class="badge bg-danger">CANCELADO</span>';
      } else {
        estadoBadge = '<span class="badge bg-warning text-dark">PENDIENTE</span>';
      }
      
      var historialHtml = '';
      d.historial.forEach(function(h) {
        historialHtml += '<tr>' +
          '<td><small>' + h.fecha + '</small></td>' +
          '<td><small>' + h.usuario + '</small></td>' +
          '<td><small class="text-info">' + h.estado_anterior + '</small> ‚Üí <small class="text-success">' + h.estado_nuevo + '</small></td>' +
          '<td><small>' + (h.comentario || '-') + '</small></td>' +
          '</tr>';
      });
      
      var html = '<div class="row">' +
        '<div class="col-md-6">' +
          '<h6 class="fw-bold text-primary"><i class="fa-solid fa-user me-2"></i>Cliente</h6>' +
          '<p>' + d.cliente + '</p>' +
          '<h6 class="fw-bold text-primary mt-3"><i class="fa-solid fa-motorcycle me-2"></i>Veh√≠culo</h6>' +
          '<p>' + d.vehiculo + '<br><small class="text-muted">Motor: ' + d.serie_motor + '</small><br><small class="text-muted">Chasis: ' + d.serie_chasis + '</small></p>' +
          '<h6 class="fw-bold text-primary mt-3"><i class="fa-solid fa-id-card me-2"></i>Placa</h6>' +
          '<p>' + (d.numero_placa ? '<span class="badge bg-dark fs-6">' + d.numero_placa + '</span>' : '<span class="badge bg-secondary">Sin asignar</span>') + '</p>' +
        '</div>' +
        '<div class="col-md-6">' +
          '<h6 class="fw-bold text-primary"><i class="fa-solid fa-info-circle me-2"></i>Estado</h6>' +
          '<p>' + estadoBadge + (d.esta_vencido ? '<span class="badge bg-danger ms-2">VENCIDO</span>' : '') + '<br><small class="text-muted">D√≠as en tr√°mite: ' + d.dias_en_tramite + '</small></p>' +
          '<h6 class="fw-bold text-primary mt-3"><i class="fa-solid fa-money-bill me-2"></i>Costos</h6>' +
          '<table class="table table-sm table-bordered">' +
            '<tr><td>Tr√°mite:</td><td class="text-end">S/ ' + d.costo_tramite.toFixed(2) + '</td></tr>' +
            '<tr><td>Placa:</td><td class="text-end">S/ ' + d.costo_placa.toFixed(2) + '</td></tr>' +
            '<tr><td>Otros:</td><td class="text-end">S/ ' + d.otros_costos.toFixed(2) + '</td></tr>' +
            '<tr class="fw-bold table-success"><td>TOTAL:</td><td class="text-end">S/ ' + d.total_costo.toFixed(2) + '</td></tr>' +
          '</table>' +
        '</div>' +
      '</div>' +
      '<hr class="my-3">' +
      '<div class="row">' +
        '<div class="col-12">' +
          '<h6 class="fw-bold text-primary"><i class="fa-solid fa-file-alt me-2"></i>Documentaci√≥n</h6>' +
          '<div class="d-flex gap-2 flex-wrap">' +
            '<span class="badge ' + (d.tiene_tarjeta_propiedad ? 'bg-success' : 'bg-secondary') + '"><i class="fa-solid fa-' + (d.tiene_tarjeta_propiedad ? 'check' : 'times') + ' me-1"></i>Tarjeta Propiedad</span>' +
            '<span class="badge ' + (d.tiene_soat ? 'bg-success' : 'bg-secondary') + '"><i class="fa-solid fa-' + (d.tiene_soat ? 'check' : 'times') + ' me-1"></i>SOAT</span>' +
            '<span class="badge ' + (d.tiene_revision_tecnica ? 'bg-success' : 'bg-secondary') + '"><i class="fa-solid fa-' + (d.tiene_revision_tecnica ? 'check' : 'times') + ' me-1"></i>Revisi√≥n T√©cnica</span>' +
          '</div>' +
        '</div>' +
      '</div>' +
      (d.observaciones ? '<div class="alert alert-secondary mt-3 mb-0"><strong><i class="fa-solid fa-comment me-2"></i>Observaciones:</strong><br>' + d.observaciones + '</div>' : '') +
      '<hr class="my-3">' +
      '<div class="mt-3">' +
        '<h6 class="fw-bold text-primary"><i class="fa-solid fa-history me-2"></i>Historial de Cambios</h6>' +
        '<div class="table-responsive" style="max-height: 250px; overflow-y: auto;">' +
          '<table class="table table-sm table-striped table-hover">' +
            '<thead class="table-light sticky-top"><tr><th>Fecha</th><th>Usuario</th><th>Cambio</th><th>Comentario</th></tr></thead>' +
            '<tbody>' + historialHtml + '</tbody>' +
          '</table>' +
        '</div>' +
      '</div>';
      
      $('#contenidoDetalle').html(html);
      new bootstrap.Modal($('#modalVerDetalle')).show();
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: res.error || 'No se pudo cargar el detalle',
        confirmButtonColor: '#dc3545'
      });
    }
  }).fail(function() {
    Swal.close();
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudo cargar el detalle',
      confirmButtonColor: '#dc3545'
    });
  });
}

// ========================================
// FUNCI√ìN: EDITAR IMPOSICI√ìN
// ========================================
function editarImposicion(id) {
  Swal.fire({
    title: 'Cargando...',
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: function() { Swal.showLoading(); }
  });
  
  $.get('/imposicion-placas/detalle/' + id + '/', function(res) {
    Swal.close();
    
    if (res.ok) {
      var d = res.data;
      
      var html = '<form id="formEditarImposicion" action="/imposicion-placas/editar/' + id + '/" method="post">' +
        '{% csrf_token %}' +
        '<div class="alert alert-info">' +
          '<strong><i class="fa-solid fa-user me-2"></i>Cliente:</strong> ' + d.cliente + '<br>' +
          '<strong><i class="fa-solid fa-motorcycle me-2"></i>Veh√≠culo:</strong> ' + d.vehiculo + '<br>' +
          '<small class="text-muted">Motor: ' + d.serie_motor + ' | Chasis: ' + d.serie_chasis + '</small>' +
        '</div>' +
        '<div class="row g-3">' +
          '<div class="col-md-4">' +
            '<label class="form-label fw-semibold">Tipo de Placa</label>' +
            '<select name="tipo_placa" class="form-select">' +
              '<option value="nueva"' + (d.tipo_placa === 'nueva' ? ' selected' : '') + '>Placa Nueva</option>' +
              '<option value="transferencia"' + (d.tipo_placa === 'transferencia' ? ' selected' : '') + '>Transferencia</option>' +
              '<option value="duplicado"' + (d.tipo_placa === 'duplicado' ? ' selected' : '') + '>Duplicado</option>' +
            '</select>' +
          '</div>' +
          '<div class="col-md-4">' +
            '<label class="form-label fw-semibold">N¬∞ de Placa</label>' +
            '<input type="text" name="numero_placa" class="form-control text-uppercase" value="' + d.numero_placa + '" maxlength="10" placeholder="ABC-123">' +
          '</div>' +
          '<div class="col-md-4">' +
            '<label class="form-label fw-semibold">Estado del Tr√°mite</label>' +
            '<select name="estado_tramite" class="form-select">' +
              '<option value="pendiente"' + (d.estado_tramite === 'pendiente' ? ' selected' : '') + '>Pendiente</option>' +
              '<option value="en_tramite"' + (d.estado_tramite === 'en_tramite' ? ' selected' : '') + '>En Tr√°mite</option>' +
              '<option value="completado"' + (d.estado_tramite === 'completado' ? ' selected' : '') + '>Completado</option>' +
              '<option value="cancelado"' + (d.estado_tramite === 'cancelado' ? ' selected' : '') + '>Cancelado</option>' +
            '</select>' +
          '</div>' +
        '</div>' +
        '<div class="row g-3 mt-2">' +
          '<div class="col-md-4">' +
            '<label class="form-label">N¬∞ Expediente</label>' +
            '<input type="text" name="numero_expediente" class="form-control" value="' + d.numero_expediente + '" placeholder="EXP-001">' +
          '</div>' +
          '<div class="col-md-4">' +
            '<label class="form-label">Fecha Tr√°mite</label>' +
            '<input type="date" name="fecha_tramite" class="form-control" value="' + d.fecha_tramite + '">' +
          '</div>' +
          '<div class="col-md-4">' +
            '<label class="form-label">Fecha Entrega</label>' +
            '<input type="date" name="fecha_entrega" class="form-control" value="' + d.fecha_entrega + '">' +
          '</div>' +
        '</div>' +
        '<div class="row g-3 mt-2">' +
          '<div class="col-md-3">' +
            '<label class="form-label">Costo Tr√°mite (S/)</label>' +
            '<input type="number" name="costo_tramite" class="form-control" step="0.01" value="' + d.costo_tramite + '" min="0">' +
          '</div>' +
          '<div class="col-md-3">' +
            '<label class="form-label">Costo Placa (S/)</label>' +
            '<input type="number" name="costo_placa" class="form-control" step="0.01" value="' + d.costo_placa + '" min="0">' +
          '</div>' +
          '<div class="col-md-3">' +
            '<label class="form-label">Otros Costos (S/)</label>' +
            '<input type="number" name="otros_costos" class="form-control" step="0.01" value="' + d.otros_costos + '" min="0">' +
          '</div>' +
          '<div class="col-md-3">' +
            '<label class="form-label">Fecha Vencimiento</label>' +
            '<input type="date" name="fecha_vencimiento_tramite" class="form-control" value="' + d.fecha_vencimiento_tramite + '">' +
          '</div>' +
        '</div>' +
        '<div class="row g-3 mt-3">' +
          '<div class="col-md-4">' +
            '<div class="form-check form-switch">' +
              '<input class="form-check-input" type="checkbox" name="tiene_tarjeta_propiedad" id="edit_tarjeta"' + (d.tiene_tarjeta_propiedad ? ' checked' : '') + '>' +
              '<label class="form-check-label" for="edit_tarjeta">Tarjeta de Propiedad</label>' +
            '</div>' +
          '</div>' +
          '<div class="col-md-4">' +
            '<div class="form-check form-switch">' +
              '<input class="form-check-input" type="checkbox" name="tiene_soat" id="edit_soat"' + (d.tiene_soat ? ' checked' : '') + '>' +
              '<label class="form-check-label" for="edit_soat">SOAT</label>' +
            '</div>' +
          '</div>' +
          '<div class="col-md-4">' +
            '<div class="form-check form-switch">' +
              '<input class="form-check-input" type="checkbox" name="tiene_revision_tecnica" id="edit_revision"' + (d.tiene_revision_tecnica ? ' checked' : '') + '>' +
              '<label class="form-check-label" for="edit_revision">Revisi√≥n T√©cnica</label>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="mt-3">' +
          '<label class="form-label fw-semibold">Observaciones</label>' +
          '<textarea name="observaciones" class="form-control" rows="2">' + d.observaciones + '</textarea>' +
        '</div>' +
        '<div class="mt-3">' +
          '<label class="form-label fw-semibold">Comentario del cambio</label>' +
          '<input type="text" name="comentario_cambio" class="form-control" placeholder="Describa brevemente los cambios realizados..." required>' +
        '</div>' +
        '<div class="modal-footer mt-4 px-0 pb-0">' +
          '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fa-solid fa-times me-2"></i>Cancelar</button>' +
          '<button type="submit" class="btn btn-primary"><i class="fa-solid fa-save me-2"></i>Guardar Cambios</button>' +
        '</div>' +
      '</form>';
      
      $('#contenidoEditar').html(html);
      
      $('#formEditarImposicion').on('submit', function(e) {
        e.preventDefault();
        
        Swal.fire({
          title: 'Guardando...',
          allowOutsideClick: false,
          showConfirmButton: false,
          willOpen: function() { Swal.showLoading(); }
        });
        
        $.ajax({
          type: 'POST',
          url: $(this).attr('action'),
          data: new FormData(this),
          processData: false,
          contentType: false,
          success: function(res) {
            if (res.ok) {
              Swal.fire({
                icon: 'success',
                title: '¬°Actualizado!',
                text: res.message,
                confirmButtonColor: '#198754'
              }).then(function() { location.reload(); });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: res.error,
                confirmButtonColor: '#dc3545'
              });
            }
          },
          error: function(xhr) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: xhr.responseJSON?.error || 'Error al procesar',
              confirmButtonColor: '#dc3545'
            });
          }
        });
      });
      
      new bootstrap.Modal($('#modalEditarImposicion')).show();
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: res.error || 'No se pudieron cargar los datos',
        confirmButtonColor: '#dc3545'
      });
    }
  }).fail(function() {
    Swal.close();
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudieron cargar los datos',
      confirmButtonColor: '#dc3545'
    });
  });
}

// ========================================
// FUNCI√ìN: CAMBIAR ESTADO
// ========================================
function cambiarEstado(id, estadoActual) {
  $('#id_imposicion_estado').val(id);
  
  var nuevoEstado = 'en_tramite';
  if (estadoActual === 'pendiente') {
    nuevoEstado = 'en_tramite';
  } else if (estadoActual === 'en_tramite') {
    nuevoEstado = 'completado';
  }
  
  $('#nuevo_estado').val(nuevoEstado);
  new bootstrap.Modal($('#modalCambiarEstado')).show();
}

function confirmarCambioEstado() {
  var id = $('#id_imposicion_estado').val();
  var nuevoEstado = $('#nuevo_estado').val();
  var comentario = $('#modalCambiarEstado').find('textarea[name="comentario"]').val();
  
  if (!comentario.trim()) {
    Swal.fire({
      icon: 'warning',
      title: 'Falta comentario',
      text: 'Debe ingresar un comentario sobre el cambio de estado',
      confirmButtonColor: '#f0ad4e'
    });
    return;
  }
  
  Swal.fire({
    title: 'Procesando...',
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: function() { Swal.showLoading(); }
  });
  
  $.post('/imposicion-placas/cambiar-estado/' + id + '/', {
    csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').first().val(),
    nuevo_estado: nuevoEstado,
    comentario: comentario
  }, function(res) {
    if (res.ok) {
      Swal.fire({
        icon: 'success',
        title: '¬°Estado actualizado!',
        text: res.message,
        confirmButtonColor: '#198754'
      }).then(function() { location.reload(); });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: res.error,
        confirmButtonColor: '#dc3545'
      });
    }
  }).fail(function(xhr) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: xhr.responseJSON?.error || 'Error al procesar',
      confirmButtonColor: '#dc3545'
    });
  });
}

// ========================================
// FUNCI√ìN: ELIMINAR IMPOSICI√ìN
// ========================================
function eliminarImposicion(id) {
  Swal.fire({
    title: '¬øEliminar imposici√≥n?',
    text: 'Esta acci√≥n no se puede deshacer',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: '<i class="fa-solid fa-trash me-2"></i>S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  }).then(function(result) {
    if (result.isConfirmed) {
      window.location.href = '/imposicion-placas/eliminar/' + id + '/';
    }
  });
}
</script>

<style>
  .card-icon {
    width: 48px;
    height: 48px;
    font-size: 1.5rem;
  }
  
  .info-card {
    border-radius: 10px;
    transition: transform 0.2s;
  }
  
  .info-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
  }
  
  .btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  
  .table-responsive {
    border-radius: 8px;
  }
  
  .badge {
    padding: 0.4em 0.65em;
    font-size: 0.85em;
  }
  
  .sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
  }
</style>
{% endblock %}