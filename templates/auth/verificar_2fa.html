<!-- templates/auth/verificar_2fa.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificación 2FA - MotoVentas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .codigo-input {
            width: 60px;
            height: 60px;
            font-size: 24px;
            text-align: center;
            margin: 0 5px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }
        .codigo-input:focus {
            border-color: #0d9488;
            box-shadow: 0 0 0 0.25rem rgba(13, 148, 136, 0.25);
        }
        .bg-gradient-teal {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center align-items-center min-vh-100">
            <div class="col-md-6">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-gradient-teal text-white text-center py-4">
                        <i class="bi bi-shield-check" style="font-size: 3rem;"></i>
                        <h4 class="mt-2 mb-0">Verificación en Dos Pasos</h4>
                    </div>
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <p class="text-muted mb-2">
                                Hola <strong>{{ nombre }}</strong>
                            </p>
                            <p class="text-muted">
                                Hemos enviado un código de 6 dígitos a:<br>
                                <strong>{{ correo }}</strong>
                            </p>
                        </div>
                        
                        <form id="form2FA">
                            {% csrf_token %}
                            <div class="d-flex justify-content-center mb-4">
                                <input type="text" class="codigo-input" maxlength="1" id="digit1" autocomplete="off">
                                <input type="text" class="codigo-input" maxlength="1" id="digit2" autocomplete="off">
                                <input type="text" class="codigo-input" maxlength="1" id="digit3" autocomplete="off">
                                <input type="text" class="codigo-input" maxlength="1" id="digit4" autocomplete="off">
                                <input type="text" class="codigo-input" maxlength="1" id="digit5" autocomplete="off">
                                <input type="text" class="codigo-input" maxlength="1" id="digit6" autocomplete="off">
                            </div>
                            
                            <input type="hidden" name="codigo" id="codigoCompleto">
                            
                            <button type="submit" class="btn btn-primary w-100 mb-3" id="btnVerificar">
                                <i class="bi bi-check-circle"></i> Verificar Código
                            </button>
                        </form>
                        
                        <div class="text-center">
                            <button class="btn btn-link text-decoration-none" id="btnReenviar">
                                <i class="bi bi-arrow-clockwise"></i> Reenviar código
                            </button>
                            <span class="mx-2">|</span>
                            <a href="{% url 'cancelar_2fa' %}" class="btn btn-link text-decoration-none text-danger">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                        </div>
                        
                        <div id="mensajes" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Manejo de inputs del código
        const inputs = document.querySelectorAll('.codigo-input');
        
        inputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value) {
                    // Mover al siguiente input
                    if (index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                }
                
                // Actualizar código completo
                actualizarCodigoCompleto();
            });
            
            input.addEventListener('keydown', (e) => {
                // Retroceder con Backspace
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    inputs[index - 1].focus();
                }
            });
            
            // Solo permitir números
            input.addEventListener('keypress', (e) => {
                if (!/[0-9]/.test(e.key)) {
                    e.preventDefault();
                }
            });
        });
        
        function actualizarCodigoCompleto() {
            const codigo = Array.from(inputs).map(input => input.value).join('');
            document.getElementById('codigoCompleto').value = codigo;
        }
        
        // Verificar código
        document.getElementById('form2FA').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const codigo = document.getElementById('codigoCompleto').value;
            
            if (codigo.length !== 6) {
                mostrarMensaje('Por favor ingresa los 6 dígitos', 'warning');
                return;
            }
            
            const formData = new FormData(this);
            const btnVerificar = document.getElementById('btnVerificar');
            
            btnVerificar.disabled = true;
            btnVerificar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verificando...';
            
            fetch('{% url "verificar_2fa" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMensaje(data.mensaje, 'success');
                    setTimeout(() => {
                        window.location.href = '{% url "cpanel" %}';
                    }, 1000);
                } else {
                    mostrarMensaje(data.error, 'danger');
                    btnVerificar.disabled = false;
                    btnVerificar.innerHTML = '<i class="bi bi-check-circle"></i> Verificar Código';
                    
                    // Limpiar inputs
                    inputs.forEach(input => input.value = '');
                    inputs[0].focus();
                }
            })
            .catch(error => {
                mostrarMensaje('Error al verificar el código', 'danger');
                btnVerificar.disabled = false;
                btnVerificar.innerHTML = '<i class="bi bi-check-circle"></i> Verificar Código';
            });
        });
        
        // Reenviar código
        document.getElementById('btnReenviar').addEventListener('click', function() {
            const btnReenviar = this;
            btnReenviar.disabled = true;
            btnReenviar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Reenviando...';
            
            fetch('{% url "reenviar_codigo_2fa" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMensaje(data.mensaje, 'success');
                    inputs.forEach(input => input.value = '');
                    inputs[0].focus();
                } else {
                    mostrarMensaje(data.error, 'danger');
                }
            })
            .catch(error => {
                mostrarMensaje('Error al reenviar el código', 'danger');
            })
            .finally(() => {
                btnReenviar.disabled = false;
                btnReenviar.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Reenviar código';
            });
        });
        
        function mostrarMensaje(mensaje, tipo) {
            const mensajes = document.getElementById('mensajes');
            mensajes.innerHTML = `
                <div class="alert alert-${tipo} alert-dismissible fade show">
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        // Autofocus en primer input
        inputs[0].focus();
    </script>
</body>
</html>