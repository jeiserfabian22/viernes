{% extends 'plantilla/base.html' %}
{% block main %}
<main id="main" class="main">
    <div class="pagetitle">
        <h1>Usuarios</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item active">Usuarios</li>
            </ol>
        </nav>
    </div><!-- End Page Title -->

    <section class="section dashboard">
        <div class="row">
            <div class="col-lg-12"> 
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Usuarios</h5> 
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#myModaAgregar">Agregar usuario</button>
                        <!-- Table with stripped rows -->
                        <table class="table datatable">
                            <thead>
                                <tr>
                                    <th scope="col">CODIGO</th>
                                    <th scope="col">NOMBRE</th>
                                    <th scope="col">Tipo usuario</th>
                                    <th scope="col">CORREO</th>
                                    <th scope="col">CONTRASEÑA</th>
                                    <th scope="col">CELULAR</th>
                                    <th scope="col">DNI</th>
                                    <th scope="col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usuario in usuarios %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ usuario.nombrecompleto }}</td>
                                        <td>{{ usuario.idtipousuario.nombretipousuario }}</td>
                                        <td>{{ usuario.correo_descifrado }}</td>
                                        <td>********</td> <!-- No mostrar contraseña hasheada -->
                                        <td>{{ usuario.celular }}</td>
                                        <td>{{ usuario.dni }}</td>
                                        <td>
                                            <a type="submit" class="btn" data-bs-toggle="modal" data-bs-target="#myModal2{{ usuario.idusuario }}">
                                                <i class="fa-solid fa-pen-to-square fa-2xl" style="color: #005eff;"></i>
                                            </a>
                                            <a href="{% url 'usuarioEliminar' id=usuario.idusuario %}" class="eliminar" onclick="return confirmarEliminar('{{ usuario.idusuario }}', this)">
                                                <i class="fa-solid fa-trash fa-2xl" style="color: #f71b02;"></i>
                                            </a>
                                        </td>  
                                    </tr>

                                    <!-- Modal de Editar -->
                                    <div class="modal" id="myModal2{{ usuario.idusuario }}">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <!-- Cabecera del modal -->
                                                <div class="modal-header">
                                                    <h4 class="modal-title">Editar usuario</h4>
                                                    <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
                                                </div>
                                                <!-- Contenido del modal De editar-->
                                                <div class="modal-body">
                                                    <!-- inicio de form -->
                                                    <form id="formEditar{{ usuario.idusuario }}" action="{% url 'usuarioEditar' %}" method="post" enctype="multipart/form-data">
                                                        {% csrf_token %}
                                                        <input type="hidden" value="{{ usuario.idusuario }}" name="idusuario" >
                                                        
                                                        <label for="nombreUsuario">Nombre</label><br>
                                                        <input type="text" value="{{ usuario.nombrecompleto }}" name="nombreUsuario" class="form-control">
                                                        
                                                        <label for="correoUsuario">CORREO</label><br>
                                                        <input type="email" value="{{ usuario.correo_descifrado }}" name="correoUsuario" class="form-control">
                                                        
                                                        <label for="contrasenaUsuario">CONTRASEÑA (dejar en blanco para no cambiar)</label><br>
                                                        <input type="password" value="" name="contrasenaUsuario" class="form-control" placeholder="Nueva contraseña (opcional)">
                                                        <input type="hidden" value="{{ usuario.contrasena }}" name="contrasenaActual">
                                                        
                                                        <label for="tipoUsuario">TIPO USUARIO</label><br>
                                                        <select class="form-select" name="tipoUsuario">
                                                            {% for tipoUsuario in tipoUsuarios %}
                                                                <option value="{{ tipoUsuario.idtipousuario }}" {% if tipoUsuario.idtipousuario == usuario.idtipousuario.idtipousuario %}selected{% endif %}>
                                                                    {{ tipoUsuario.nombretipousuario }}
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                        
                                                        <label for="celularUsuario">CELULAR</label><br>
                                                        <input type="text" value="{{ usuario.celular }}" name="celularUsuario" class="form-control">
                                                        
                                                        <label for="dniUsuario">DNI</label><br>
                                                        <input type="text" value="{{ usuario.dni }}" name="dniUsuario" class="form-control">
                                                        
                                                        <div style="display:flex; margin-left:140px;">
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary btn-editar" data-form-id="formEditar{{ usuario.idusuario }}">Editar</button>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                                            </div>
                                                        </div>
                                                    </form>
                                                    <!-- fin del form -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Fin del modal -->
                               {% endfor %}
                            </tbody>
                        </table>
                        <!-- End Table with stripped rows -->
                    </div>
                </div>
            </div>
        </div>
    </section>
</main><!-- End #main -->

<!-- Modal de Agregar -->
<div class="modal" id="myModaAgregar">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Cabecera del modal -->
            <div class="modal-header">
                <h4 class="modal-title">Agregar usuario</h4>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <!-- Contenido del modal de agregar -->
            <div class="modal-body">
                <!-- inicio de form -->
                <form id="formAgregar" action="{% url 'usuarioAgregar' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <label for="nombreUsuario2">Nombre</label><br>
                    <input type="text" name="nombreUsuario2" class="form-control" autocomplete="off" required>
                
                    <label for="correoUsuario2">CORREO</label><br>
                    <input type="email" name="correoUsuario2" class="form-control" required>
                
                    <label for="contrasenaUsuario2">CONTRASEÑA</label><br>
                    <input type="password" name="contrasenaUsuario2" class="form-control" required>
                
                    <label for="tipoUsuario2">TIPO USUARIO</label><br>
                    <select class="form-select" name="tipoUsuario2" required>
                        {% for tipoUsuario in tipoUsuarios %}
                            <option value="{{ tipoUsuario.idtipousuario }}">{{ tipoUsuario.nombretipousuario }}</option>
                        {% endfor %}
                    </select>
                
                    <label for="celularUsuario2">CELULAR</label><br>
                    <input type="text" name="celularUsuario2" class="form-control" required>
                
                    <label for="dniUsuario2">DNI</label><br>
                    <input type="text" name="dniUsuario2" class="form-control" required>
                
                    <div style="display:flex; margin-left:140px;">
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="btnAgregar">Agregar</button>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </form>
                <!-- fin del form -->
            </div>
        </div>
    </div>
</div>
<!-- Fin del modal -->

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
    // Función para obtener el token CSRF de las cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Agregar usuario
    $('#btnAgregar').click(function() {
        var formData = new FormData($('#formAgregar')[0]);
        $.ajax({
            type: 'POST',
            url: "{% url 'usuarioAgregar' %}",
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(response) {
                Swal.fire({
                    title: 'Usuario agregado exitosamente',
                    icon: 'success',
                    confirmButtonText: '¡Ok!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = "{% url 'usuarios' %}";
                    }
                });
            },
            error: function(response) {
                Swal.fire({
                    title: 'Error al guardar el usuario',
                    text: response.responseJSON ? response.responseJSON.error : response.responseText,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
        return false;
    });

    // Editar usuario
    $('.btn-editar').click(function() {
        var formId = $(this).data('form-id');
        var form = $('#' + formId);
        var formData = new FormData(form[0]);
        
        // Si el campo de contraseña está vacío, enviamos la contraseña actual (hasheada)
        var nuevaContrasena = form.find('input[name="contrasenaUsuario"]').val();
        if (!nuevaContrasena || nuevaContrasena.trim() === '') {
            var contrasenaActual = form.find('input[name="contrasenaActual"]').val();
            formData.set('contrasenaUsuario', contrasenaActual);
        }
        
        $.ajax({
            type: 'POST',
            url: "{% url 'usuarioEditar' %}",
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(response) {
                Swal.fire({
                    title: 'Usuario editado exitosamente',
                    icon: 'success',
                    confirmButtonText: '¡Ok!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = "{% url 'usuarios' %}";
                    }
                });
            },
            error: function(response) {
                Swal.fire({
                    title: 'Error al editar el usuario',
                    text: response.responseJSON ? response.responseJSON.error : response.responseText,
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
        return false;
    });

    // Confirmar eliminación de usuario
    function confirmarEliminar(id, enlace) {
        let urlEliminar = $(enlace).attr('href');
        Swal.fire({
            title: '¿Seguro que quieres eliminar este usuario?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: 'GET',
                    url: urlEliminar,
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                    success: function(response) {
                        window.location.href = "{% url 'usuarios' %}";
                    },
                    error: function(response) {
                        Swal.fire({
                            title: 'Error al eliminar el usuario',
                            text: response.responseText,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            }
        });
        return false;
    }
</script>
{% endblock %}
